{% extends "base.html" %}
{% block title %}Bond Calculators{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2>Bond Calculators</h2>
    
    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs mb-4" id="bondTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="pv-tab" data-bs-toggle="tab" data-bs-target="#pv" type="button" role="tab" aria-controls="pv" aria-selected="true">Present/Future Value</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="zero-tab" data-bs-toggle="tab" data-bs-target="#zero" type="button" role="tab" aria-controls="zero" aria-selected="false">Zero Coupon Bonds</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="coupon-tab" data-bs-toggle="tab" data-bs-target="#coupon" type="button" role="tab" aria-controls="coupon" aria-selected="false">Coupon Bonds</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="perpetuity-tab" data-bs-toggle="tab" data-bs-target="#perpetuity" type="button" role="tab" aria-controls="perpetuity" aria-selected="false">Perpetuities</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="yield-tab" data-bs-toggle="tab" data-bs-target="#yield" type="button" role="tab" aria-controls="yield" aria-selected="false">Yield Calculator</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="duration-tab" data-bs-toggle="tab" data-bs-target="#duration" type="button" role="tab" aria-controls="duration" aria-selected="false">Duration Analysis</button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="bondTabContent">
        <!-- Present/Future Value Calculator -->
        <div class="tab-pane fade show active" id="pv" role="tabpanel" aria-labelledby="pv-tab">
            <div class="card">
                <div class="card-body">
                    <h3>Present/Future Value Calculator</h3>
                    <form id="pvForm">
                        <div class="form-group">
                            <label>Calculation Type</label>
                            <select class="form-control" id="pvCalculationType">
                                <option value="future">Calculate Future Value</option>
                                <option value="present">Calculate Present Value</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label id="valueLabel">Present Value</label>
                            <input type="number" step="0.01" class="form-control" id="value" required>
                        </div>
                        <div class="form-group">
                            <label>Interest Rate (%)</label>
                            <input type="number" step="0.01" class="form-control" id="pvInterestRate" required>
                        </div>
                        <div class="form-group">
                            <label>Years</label>
                            <input type="number" step="1" class="form-control" id="pvYears" required>
                        </div>
                        <button type="submit" class="btn btn-primary mt-3">Calculate</button>
                    </form>
                    <div id="pvResult" class="mt-3"></div>
                </div>
            </div>
        </div>

        <!-- Zero Coupon Bond Calculator -->
        <div class="tab-pane fade" id="zero" role="tabpanel" aria-labelledby="zero-tab">
            <div class="card">
                <div class="card-body">
                    <h3>Zero Coupon Bond Calculator</h3>
                    <form id="zeroForm">
                        <div class="form-group">
                            <label>Face Value</label>
                            <input type="number" step="0.01" class="form-control" id="zeroFaceValue" required>
                        </div>
                        <div class="form-group">
                            <label>Years to Maturity</label>
                            <input type="number" step="1" class="form-control" id="zeroYearsToMaturity" required>
                        </div>
                        <div class="form-group">
                            <label>Interest Rate (%)</label>
                            <input type="number" step="0.01" class="form-control" id="zeroInterestRate" required>
                        </div>
                        <button type="submit" class="btn btn-primary mt-3">Calculate Price</button>
                    </form>
                    <div id="zeroResult" class="mt-3"></div>
                </div>
            </div>
        </div>

        <!-- Coupon Bond Calculator -->
        <div class="tab-pane fade" id="coupon" role="tabpanel" aria-labelledby="coupon-tab">
            <div class="card">
                <div class="card-body">
                    <h3>Coupon Bond Calculator</h3>
                    <form id="couponForm">
                        <div class="form-group">
                            <label>Face Value</label>
                            <input type="number" step="0.01" class="form-control" id="couponFaceValue" required>
                        </div>
                        <div class="form-group">
                            <label>Coupon Rate (%)</label>
                            <input type="number" step="0.01" class="form-control" id="couponRate" required>
                        </div>
                        <div class="form-group">
                            <label>Years to Maturity</label>
                            <input type="number" step="1" class="form-control" id="couponYearsToMaturity" required>
                        </div>
                        <div class="form-group">
                            <label>Payments Per Year</label>
                            <select class="form-control" id="paymentsPerYear">
                                <option value="1">Annual</option>
                                <option value="2">Semi-Annual</option>
                                <option value="4">Quarterly</option>
                                <option value="12">Monthly</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Market Interest Rate (%)</label>
                            <input type="number" step="0.01" class="form-control" id="couponInterestRate" required>
                        </div>
                        <button type="submit" class="btn btn-primary mt-3">Calculate Price</button>
                    </form>
                    <div id="couponResult" class="mt-3"></div>
                </div>
            </div>
        </div>

        <!-- Perpetuity Calculator -->
        <div class="tab-pane fade" id="perpetuity" role="tabpanel" aria-labelledby="perpetuity-tab">
            <div class="card">
                <div class="card-body">
                    <h3>Perpetuity Calculator</h3>
                    <form id="perpetuityForm">
                        <div class="form-group">
                            <label>Annual Coupon Payment</label>
                            <input type="number" step="0.01" class="form-control" id="perpetuityCouponPayment" required>
                        </div>
                        <div class="form-group">
                            <label>Interest Rate (%)</label>
                            <input type="number" step="0.01" class="form-control" id="perpetuityInterestRate" required>
                        </div>
                        <button type="submit" class="btn btn-primary mt-3">Calculate Price</button>
                    </form>
                    <div id="perpetuityResult" class="mt-3"></div>
                </div>
            </div>
        </div>

        <!-- Yield Calculator -->
        <div class="tab-pane fade" id="yield" role="tabpanel" aria-labelledby="yield-tab">
            <div class="card">
                <div class="card-body">
                    <h3>Yield to Maturity Calculator</h3>
                    <p class="text-muted">Calculate yield to maturity using linear interpolation method.</p>
                    <form id="yieldForm">
                        <div class="form-group">
                            <label>Face Value</label>
                            <input type="number" step="0.01" class="form-control" id="yieldFaceValue" required>
                        </div>
                        <div class="form-group">
                            <label>Coupon Rate (%)</label>
                            <input type="number" step="0.01" class="form-control" id="yieldCouponRate" required>
                        </div>
                        <div class="form-group">
                            <label>Years to Maturity</label>
                            <input type="number" step="0.5" class="form-control" id="yieldYearsToMaturity" required>
                        </div>
                        <div class="form-group">
                            <label>Current Market Price</label>
                            <input type="number" step="0.01" class="form-control" id="yieldCurrentPrice" required>
                        </div>
                        <div class="form-group">
                            <label>Payments Per Year</label>
                            <select class="form-control" id="yieldPaymentsPerYear">
                                <option value="1">Annual</option>
                                <option value="2">Semi-Annual</option>
                                <option value="4">Quarterly</option>
                                <option value="12">Monthly</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary mt-3">Calculate Yield</button>
                    </form>
                    <div id="yieldResult" class="mt-3"></div>
                </div>
            </div>
        </div>

        <!-- Duration Analysis -->
        <div class="tab-pane fade" id="duration" role="tabpanel" aria-labelledby="duration-tab">
            <div class="card">
                <div class="card-body">
                    <h3>Duration Analysis</h3>
                    <p class="text-muted">Calculate Macaulay Duration, Modified Duration, and estimate price sensitivity.</p>
                    <form id="durationForm">
                        <div class="form-group">
                            <label>Face Value</label>
                            <input type="number" step="0.01" class="form-control" id="durationFaceValue" required>
                        </div>
                        <div class="form-group">
                            <label>Coupon Rate (%)</label>
                            <input type="number" step="0.01" class="form-control" id="durationCouponRate" required>
                        </div>
                        <div class="form-group">
                            <label>Years to Maturity</label>
                            <input type="number" step="0.5" class="form-control" id="durationYearsToMaturity" required>
                        </div>
                        <div class="form-group">
                            <label>Yield Rate (%)</label>
                            <input type="number" step="0.01" class="form-control" id="durationYieldRate" required>
                        </div>
                        <div class="form-group">
                            <label>Payments Per Year</label>
                            <select class="form-control" id="durationPaymentsPerYear">
                                <option value="1">Annual</option>
                                <option value="2">Semi-Annual</option>
                                <option value="4">Quarterly</option>
                                <option value="12">Monthly</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Yield Change for Sensitivity (basis points)</label>
                            <input type="number" step="1" class="form-control" id="yieldChange" value="100" required>
                            <small class="form-text text-muted">Enter the yield change in basis points (e.g., 100 = 1%)</small>
                        </div>
                        <button type="submit" class="btn btn-primary mt-3">Calculate Duration</button>
                    </form>
                    <div id="durationResult" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
// Initialize Bootstrap tabs
document.addEventListener('DOMContentLoaded', function() {
    var triggerTabList = [].slice.call(document.querySelectorAll('#bondTabs button'));
    triggerTabList.forEach(function(triggerEl) {
        new bootstrap.Tab(triggerEl);
    });
});

// Present/Future Value Calculator
document.getElementById('pvCalculationType').addEventListener('change', function() {
    const valueLabel = document.getElementById('valueLabel');
    valueLabel.textContent = this.value === 'future' ? 'Present Value' : 'Future Value';
});

document.getElementById('pvForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const type = document.getElementById('pvCalculationType').value;
    const value = parseFloat(document.getElementById('value').value);
    const interestRate = parseFloat(document.getElementById('pvInterestRate').value) / 100;
    const years = parseInt(document.getElementById('pvYears').value);

    try {
        const response = await fetch('/calculate_pv_fv', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type, value, interest_rate: interestRate, years })
        });
        const data = await response.json();
        if (data.error) {
            document.getElementById('pvResult').innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
        } else {
            document.getElementById('pvResult').innerHTML = `
                <div class="alert alert-success">
                    <h4>${type === 'future' ? 'Future' : 'Present'} Value: $${data.result.toFixed(2)}</h4>
                </div>`;
        }
    } catch (error) {
        document.getElementById('pvResult').innerHTML = `<div class="alert alert-danger">Error in calculation</div>`;
    }
});

// Zero Coupon Bond Calculator
document.getElementById('zeroForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const faceValue = parseFloat(document.getElementById('zeroFaceValue').value);
    const yearsToMaturity = parseInt(document.getElementById('zeroYearsToMaturity').value);
    const interestRate = parseFloat(document.getElementById('zeroInterestRate').value) / 100;

    try {
        const response = await fetch('/calculate_zero_coupon', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                face_value: faceValue,
                years_to_maturity: yearsToMaturity,
                interest_rate: interestRate
            })
        });
        const data = await response.json();
        if (data.error) {
            document.getElementById('zeroResult').innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
        } else {
            document.getElementById('zeroResult').innerHTML = `
                <div class="alert alert-success">
                    <h4>Bond Price: $${data.price.toFixed(2)}</h4>
                    <h4>Yield to Maturity: ${(data.ytm * 100).toFixed(2)}%</h4>
                </div>`;
        }
    } catch (error) {
        document.getElementById('zeroResult').innerHTML = `<div class="alert alert-danger">Error in calculation</div>`;
    }
});

// Coupon Bond Calculator
document.getElementById('couponForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const faceValue = parseFloat(document.getElementById('couponFaceValue').value);
    const couponRate = parseFloat(document.getElementById('couponRate').value) / 100;
    const yearsToMaturity = parseInt(document.getElementById('couponYearsToMaturity').value);
    const paymentsPerYear = parseInt(document.getElementById('paymentsPerYear').value);
    const interestRate = parseFloat(document.getElementById('couponInterestRate').value) / 100;

    try {
        const response = await fetch('/calculate_coupon_bond', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                face_value: faceValue,
                coupon_rate: couponRate,
                years_to_maturity: yearsToMaturity,
                payments_per_year: paymentsPerYear,
                interest_rate: interestRate
            })
        });
        const data = await response.json();
        if (data.error) {
            document.getElementById('couponResult').innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
        } else {
            document.getElementById('couponResult').innerHTML = `
                <div class="alert alert-success">
                    <h4>Bond Price: $${data.price.toFixed(2)}</h4>
                    <h4>Yield to Maturity: ${(data.ytm * 100).toFixed(2)}%</h4>
                </div>`;
        }
    } catch (error) {
        document.getElementById('couponResult').innerHTML = `<div class="alert alert-danger">Error in calculation</div>`;
    }
});

// Perpetuity Calculator
document.getElementById('perpetuityForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const couponPayment = parseFloat(document.getElementById('perpetuityCouponPayment').value);
    const interestRate = parseFloat(document.getElementById('perpetuityInterestRate').value) / 100;

    try {
        const response = await fetch('/calculate_perpetuity', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                coupon_payment: couponPayment,
                interest_rate: interestRate
            })
        });
        const data = await response.json();
        if (data.error) {
            document.getElementById('perpetuityResult').innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
        } else {
            document.getElementById('perpetuityResult').innerHTML = `
                <div class="alert alert-success">
                    <h4>Perpetuity Price: $${data.price.toFixed(2)}</h4>
                    <h4>Yield to Maturity: ${(data.ytm * 100).toFixed(2)}%</h4>
                </div>`;
        }
    } catch (error) {
        document.getElementById('perpetuityResult').innerHTML = `<div class="alert alert-danger">Error in calculation</div>`;
    }
});

// Yield Calculator
document.getElementById('yieldForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const face_value = parseFloat(document.getElementById('yieldFaceValue').value);
    const coupon_rate = parseFloat(document.getElementById('yieldCouponRate').value) / 100;
    const years_to_maturity = parseFloat(document.getElementById('yieldYearsToMaturity').value);
    const current_price = parseFloat(document.getElementById('yieldCurrentPrice').value);
    const payments_per_year = parseInt(document.getElementById('yieldPaymentsPerYear').value);

    try {
        const response = await fetch('/calculate_yield', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                face_value,
                coupon_rate,
                years_to_maturity,
                current_price,
                payments_per_year
            })
        });
        const data = await response.json();
        if (data.error) {
            document.getElementById('yieldResult').innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
        } else {
            document.getElementById('yieldResult').innerHTML = `
                <div class="alert alert-success">
                    <h4>Yield to Maturity: ${(data.yield * 100).toFixed(2)}%</h4>
                </div>`;
        }
    } catch (error) {
        document.getElementById('yieldResult').innerHTML = `<div class="alert alert-danger">Error in calculation</div>`;
    }
});

// Duration Calculator
document.getElementById('durationForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const face_value = parseFloat(document.getElementById('durationFaceValue').value);
    const coupon_rate = parseFloat(document.getElementById('durationCouponRate').value) / 100;
    const years_to_maturity = parseFloat(document.getElementById('durationYearsToMaturity').value);
    const yield_rate = parseFloat(document.getElementById('durationYieldRate').value) / 100;
    const payments_per_year = parseInt(document.getElementById('durationPaymentsPerYear').value);
    const yield_change = parseFloat(document.getElementById('yieldChange').value) / 10000; // Convert basis points to decimal

    try {
        const durationResponse = await fetch('/calculate_duration', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                face_value,
                coupon_rate,
                years_to_maturity,
                yield_rate,
                payments_per_year
            })
        });
        const durationData = await durationResponse.json();
        
        if (durationData.error) {
            document.getElementById('durationResult').innerHTML = `<div class="alert alert-danger">${durationData.error}</div>`;
            return;
        }

        // Calculate price sensitivity
        const priceResponse = await fetch('/estimate_price_change', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                duration: durationData.modified_duration,
                yield_change: yield_change
            })
        });
        const priceData = await priceResponse.json();

        if (priceData.error) {
            document.getElementById('durationResult').innerHTML = `<div class="alert alert-danger">${priceData.error}</div>`;
            return;
        }

        document.getElementById('durationResult').innerHTML = `
            <div class="alert alert-success">
                <h4>Duration Analysis Results:</h4>
                <p>Macaulay Duration: ${durationData.macaulay_duration.toFixed(2)} years</p>
                <p>Modified Duration: ${durationData.modified_duration.toFixed(2)} years</p>
                <p>Price Sensitivity: For a ${document.getElementById('yieldChange').value} basis point change in yield,
                   the estimated price change would be ${priceData.price_change.toFixed(2)}%</p>
            </div>`;
    } catch (error) {
        document.getElementById('durationResult').innerHTML = `<div class="alert alert-danger">Error in calculation</div>`;
    }
});

</script>
{% endblock %}
{% endblock %}
